---
title: "Bootstrapについて"
author: "Nozomi Niimi"
format:
  revealjs:
    smaller: true
height: 700
width: 960
engine: knitr
bibliography: bootstrap.bib
---

```{r, setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  comment = '', fig.width = 6, fig.height = 6, echo = FALSE, warning = FALSE
)
library(tibble)
library(dplyr)
library(gt)
library(gtExtras)
library(kableExtra)
library(boot)
library(bootstrap)
```


## Take home messages

普通に95%信頼区間が出せない時に.

-   大元のデータから
-   n = 1000以上で
-   Bootstrap標本を使って計算する
-   基本はPercentile法で良いが、BCa法やBootstrap t標本という手もある

## Introduction

-   最近研究でbootstrapを使う事が複数回あった
-   正直雰囲気でやっていたので、しっかり勉強してみたい

## 95％信頼区間の出し方

::: columns
::: {.column width="45%"}
```{r bmi}
dat <- tibble(
    id = 1:300, 
    bmi = rnorm(n = 300, mean = 21, sd = 2.0)
)
kable(head(dat, 10)) |> 
  kable_styling(font_size = 20)
```
:::
::: {.column width="10%"}

:::
::: {.column width="45%"}
```{r mi-hist}

hist(dat$bmi)
```
:::
:::

-   例えば、患者のBMIを出すときはどう考えるか？

## 信頼区間の出し方

-   この分布が**正規分布に従うとして**、t分布の平均と分散を最尤法で推定
-   t分布の数表を確認して、1.96×標準偏差で計算する

## でも・・・・・・

-   心不全患者のBNPの分布は？
-   新しいDeep learningモデルのtest cohortでのAUROCの分散は？
-   死亡、心不全再入院という風に階層をおいた時のWin ratioの95%信頼区間は？

医学では[**正規分布**]{style="color: red"}でないものの方が多い！

## Bootstrapとは

-   Jackknife法などと同じresampling法の一種
-   Efronが1979年に開発した手法
-   元のデータからランダムに取り出す[@Efron2003-pq]
-   この際に[**重複を許可する**]{style="color: red"}のが特徴 = 使われないのもある

## おまけ〜Bootstrapの名前

::: {style="font-size: 0.3"}
-   ホラ吹き男爵の冒険のエピソード
-   「余は、底なし沼にハマった時に自分のBootstrapを引っぱって抜け出したことがある
-   読んでみたが、この本にはそのエピソードなし(そのエピソードは存在しないという説もあり)

![](images/bootstrap_horafuki.jpg){height="170px" fig-align="center"} 
:::

## Bootstrap法〜Jackknifeとの比較

-   Bootstrapの前に、Jackknifeという手法が1949年に開発された
-   これは、1つずつ標本から抜いていくという手法
-   どんな時にも使えるから、便利な十徳ナイフという名前が付けられた
-   こっちの方が自然なイメージだが**問題点**があった

![](images/Jackknife.png){height="160px" fig-align="center"}

## Jacknife法の問題点1

-   　MIを起こした患者の年齢とLDLを見たデータがあるとする

```{r}
nums = 29
mi_dat <- data.frame(
    id = 1:nums, 
    age = rnorm(n = nums, mean = 75, sd = 3), 
    ldl = runif(n = nums, min = 170, max = 210), 
    comment = rep("  ", nums)
) |> 
tibble::add_row(id = nums + 1, age = 25, ldl = 300, comment = "FHの患者") |> 
tibble::add_row(id = nums + 2, age = 35, ldl = 75, comment = "特発性冠動脈解離")

dplyr::slice(mi_dat, 1:3, 30, 31) |> 
  gt::gt() |> 
  gtExtras::gt_highlight_rows(rows = 4:5, fill = "lightgrey",
                              bold_target_only = TRUE, 
                              target_col = comment)
```

## Jacknife法の問題点2

::: columns
::: {.column width="50%"}
```{r}
hist(mi_dat$age, breaks = 40)
```
:::

::: {.column width="50%"}
```{r warning=FALSE,message=FALSE}
hist(mi_dat$ldl, breaks = 30)
```
:::
:::

## その場合

-   このようなデータ(連続じゃない時)の時に分散を広く推定してしまう
-   イメージだが、外れ値を何度も数えてしまう (FHを29回数えている)
-   平均値とSDは出来るが、中央値とPercentileは苦手

## Bootstrapの前提条件

-   Plug in principles
-   簡単にいうと「標本の分布は母集団の分布とほぼ同じ」というもの

![](images/bootstrap_image.jpg){height="350px" fig-align="center"}

## bootstrapの簡単な例

::: columns
::: {.column width="45%"}
```{r, starwars}
dat_star <- dplyr::select(starwars, name, height, mass, species)

knitr::kable(head(dat_star, 8), format = "html") |> 
  kableExtra::kable_styling(font_size = 20)
```
:::

::: {.column width="10%"}
:::

::: {.column width="45%"}
```{r}
hist(dat_star$height)
```
:::
:::

-    簡単なものとして、身長の平均値と標準誤差を出してみる


## How to bootstrap 1

::: columns
::: {.column width="50%"}
```{r, bootstrap-method1}
set.seed(4)
sw_ids <- sample(nrow(starwars), replace = TRUE) |> 
  sort()

sw_ids
```
:::

::: {.column width="50%"}
```{r}

sw_boot1 <- dat_star |> 
  dplyr::slice(sw_ids) 

kable(head(sw_boot1, 15)) |> 
  kableExtra::kable_styling(font_size = 16)

```
:::
:::

-  行数の数字をランダムに抽出する<br>
-  この時、重複を許す！


## How to bootstrap 2

-   同じものが複数ある(C3PO)
-   この状態で身長の平均値を出す。
-   身長の平均値 = `r mean(sw_boot1$height, na.rm = T)`

## How to bootstrap 3

-   上記の1と2を繰り返す。

```{r}
#| fig-align: "center"

boot_mean <- \(dat, i){
  datas <- dat[i, ]
  mean(datas$height, na.rm = TRUE)
}

boot_height <- boot(dat_star, statistic = boot_mean, R = 500)

plot(boot_height)

```

## How to bootstrap 4

-   ここからやり方は複数ある[@Bland2015-gy]

1.  統計量の分布が正規分布の場合は通常の方法(1.96xSD)をする事がある <br> 
→ sd = `r sd(boot_height$t)`
2.  2.5% \~ 97.5%の範囲をそのまま提示する <br>
→ [`r quantile(boot_height$t, probs = c(0.025, 0.0975))`]

::: callout-note
どの方法を用いるにせよ必ず1回は**Histogram**にして分布を確認する！！
:::

## Bootstrapの種類

-   最も基本は上記の**Percentile法** <br>
→ ただし、**以下にのべる弱点**がある
- Percentile法の弱点
1. 収束が遅い
2. 元データを使っていない
→ Biasが生まれる

## Bootstrap法の改善

-   Biasを修正する為に複数のパラメーターを使う
-   BC法: Bootstrapだけでなんとかなる
-   BCa法(ABC法): 
https://blogs.sas.com/content/iml/2017/07/12/bootstrap-bca-interval.html

## どれを選べばいいの？

![](images/choice_bootstrap.png){height="300px"}

-   可能なら専門家に確認する
-   過去の論文[@Carpenter2000-fo]では、Flowchartが示されているが・・・・・・
-   全く分からなければBCa法が無難だと思う
-   BCa法は・・・・・・

## Bootstrapの素朴な疑問

-   nは幾つにすればいいの？
-   元データはどれくらい必要なの？

## Take home message
